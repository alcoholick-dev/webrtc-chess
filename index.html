<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>WebRTC Chess â€” Large Board</title>
	<script src="/webrtc-chess/chess.min.js"></script>
	<link rel="icon" type="image/x-icon" href="/webrtc-chess/favicon.ico" />
	<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" crossorigin="anonymous" />
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" crossorigin="anonymous"></script>

	<style>
		:root{
			--bg:#071025;
			--card:#071827;
			--muted:#9fb0c6;
			--accent:#06b6d4;
			--radius:12px;
			--gap:16px;
		}
		*{box-sizing:border-box}
		html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:#e6eef6;background:linear-gradient(180deg,#03121a 0%, #071025 100%)}
		.container{
			max-width:1200px;margin:20px auto;padding:16px;display:grid;gap:16px;
			/* layout: board prominent on left, info on right; collapse on narrow */
			grid-template-columns: minmax(520px, 1fr) 360px;
			align-items:start;
		}
		.header{grid-column:1/3;display:flex;justify-content:space-between;align-items:center;gap:12px}
		.title{font-size:20px;font-weight:600}
		.small{color:var(--muted);font-size:13px}

		/* BOARD CARD - make it dominant and responsive */
		.board-card{
			background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
			border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);
			display:flex;flex-direction:column;gap:12px;
		}
		#board2{
			/* big responsive sizing:
			   - min 420px
			   - ideal scales with viewport via vmin
			   - max 92vh for very tall screens or 920px on wide screens
			*/
			width: clamp(420px, 62vmin, 920px);
			max-width: calc(100vw - 420px); /* prevents overflow when sidebar present */
			height: clamp(420px, 62vmin, 92vh);
			max-height: 92vh;
			aspect-ratio: 1 / 1;
			background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.06));
			border-radius:10px;padding:10px;position:relative;display:flex;align-items:center;justify-content:center;
		}
		.board-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}

		.controls{display:flex;gap:8px;align-items:center}
		button.btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;cursor:pointer}
		button.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);border:none;color:#041022}

		.info-panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
		.player{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
		.avatar{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021022}

		/* Mobile: stack layout, board on top and very large */
		@media (max-width:1000px){
			.container{grid-template-columns:1fr;padding:12px}
			#board2{
				/* make board fill viewport width (with small padding) and be larger via vh */
				width: min(92vw, 92vh);
				height: min(92vw, 92vh);
				max-width:92vw;
				max-height:92vh;
			}
		}

		/* extra-wide screens: limit sidebar to reasonable width */
		@media (min-width:1500px){
			.container{grid-template-columns: 1fr 380px}
			#board2{ max-width:1100px; width: clamp(520px, 58vmin, 1100px) }
		}
	</style>
</head>
<body>
	<div class="container">
		<header class="header">
			<div>
				<div class="title">WebRTC Chess</div>
				<div class="small">Big responsive board â€” drag pieces to move</div>
			</div>
			<div style="display:flex;gap:8px;align-items:center">
				<div class="small">Room: <strong id="roomVal">â€”</strong></div>
				<button class="btn" id="soundToggle">ðŸ”Š</button>
			</div>
		</header>

		<section class="board-card">
			<div id="board2" class="board-wrap">
				<div id="board-loading" class="small">Finding othersâ€¦</div>
			</div>

			<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
				<div class="controls">
					<button class="btn primary" id="btn-new">New Game</button>
					<button class="btn" id="btn-resign">Resign</button>
					<button class="btn" id="btn-offer">Offer Draw</button>
				</div>
				<div class="small" id="turn-ind">Turn: <strong id="turnVal">â€”</strong></div>
			</div>
			<div class="small" id="game-status" style="margin-top:8px">Status: waiting for playerâ€¦</div>
		</section>

		<aside class="info-panel">
			<div style="margin-bottom:12px"><strong>Players</strong></div>
			<div class="player">
				<div style="display:flex;gap:10px;align-items:center">
					<div class="avatar">Me</div>
					<div>
						<div id="name-me">You</div>
						<div class="small" id="color-me">Color: â€”</div>
					</div>
				</div>
				<div class="small" id="score-me">â€”</div>
			</div>

			<div class="player">
				<div style="display:flex;gap:10px;align-items:center">
					<div class="avatar">OP</div>
					<div>
						<div id="name-them">Opponent</div>
						<div class="small" id="color-them">Color: â€”</div>
					</div>
				</div>
				<div class="small" id="score-them">â€”</div>
			</div>

			<hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

			<div><strong>Game info</strong></div>
			<div style="margin-top:8px" class="small">FEN: <span id="fen">â€”</span></div>
			<div class="small">Moves: <span id="moves">0</span></div>
			<div class="small">Last: <span id="last-move">â€”</span></div>
		</aside>
	</div>

	<!-- promo template -->
	<div id="promo-template" style="display:none">
		<div class="promo-overlay" role="dialog" aria-modal="true" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">
			<div style="background:rgba(0,0,0,0.6);padding:12px;border-radius:8px;display:flex;gap:8px" id="promo-card"></div>
		</div>
	</div>

	<script type="module">
		import {joinRoom, selfId} from '/webrtc-chess/trystero-mqtt.min.js';

		async function base64ToArrayBuffer(b64){const bin=atob(b64);const len=bin.length;const buf=new Uint8Array(len);for(let i=0;i<len;i++)buf[i]=bin.charCodeAt(i);return buf.buffer}
		async function decrypt(key,payload){const KEY_LEN=32,ALGO='AES-GCM';const keyBuf=await base64ToArrayBuffer(key);if(keyBuf.byteLength!==KEY_LEN)throw new Error('masterKey must be 32 bytes (base64-encoded)');const ivBuf=new Uint8Array(await base64ToArrayBuffer(payload.iv));const ctBuf=new Uint8Array(await base64ToArrayBuffer(payload.ciphertext));const tagBuf=new Uint8Array(await base64ToArrayBuffer(payload.tag));const combined=new Uint8Array(ctBuf.length+tagBuf.length);combined.set(ctBuf,0);combined.set(tagBuf,ctBuf.length);const cryptoKey=await crypto.subtle.importKey('raw',keyBuf,{name:ALGO},false,['decrypt']);const plainBuf=await crypto.subtle.decrypt({name:ALGO,iv:ivBuf,tagLength:128},cryptoKey,combined.buffer);return new TextDecoder().decode(plainBuf)}

		window.onload = async () => {
			const effect = new Audio('/webrtc-chess/img/effect.mp3');
			let soundOn = true;
			document.getElementById('soundToggle').addEventListener('click', ()=>{ soundOn = !soundOn; document.getElementById('soundToggle').textContent = soundOn ? 'ðŸ”Š' : 'ðŸ”ˆ'; });

			const roomObj = joinRoom({
				appId: 'michael-chess-app-dcb25a3c-7064-40f8-aef7-593ca98b3e3c',
				rtcConfig: {
					iceServers: [
						{
							urls: ['turn:1xoxshf.257.cz:3478'],
							...JSON.parse(await decrypt('dfGHBn6y+efs/KewqK35WwBJ1AT4jzFOrkNHTb8El3s=', {
								iv: 'S1uthG23SvdgvThn',
								ciphertext: 'F7B9jtXqLBZKAmp1ptHzTizsQA3AlwvOH7j7vgYiLmc3BR7l8g225WtShR7v07hbYaxpPdNfQKKKp7dsvb4=',
								tag: '5qsE+oIAHUtCaBQgBQzWHQ=='
							}))
						},
						{ urls:['stun:stun.nextcloud.com:3478'] }
					]
				}
			}, 'f50782ab-81f7-4f84-84c3-02a40dd52df6');

			document.getElementById('roomVal').textContent = roomObj.id || 'â€”';

			let systemId = '';
			async function* handleColor() {
				const options = ['r','p','s'];
				const [sendColor, getColor] = roomObj.makeAction('handleColor');
				let _resp = null;
				while (!_resp) {
					const userIndex = Math.floor(Math.random()*options.length);
					const option = options[userIndex];
					sendColor(option);
					roomObj.onPeerJoin(peerId => sendColor(option, peerId));
					_resp = await new Promise(resp => {
						getColor((color, friendId) => {
							systemId = friendId;
							const systemIndex = options.indexOf(color);
							const score = systemIndex - userIndex;
							if (score == 1 || score == -2) return resp('black');
							if (score == 0) resp(null);
							resp('white');
						});
					});
					yield _resp;
				}
			}
			roomObj.onPeerLeave(peerId => {
				if (peerId !== systemId) return;
				alert('Other user left! Leaving...');
				roomObj.leave();
				window.location.reload();
			});
			const mappings = {};
			let color = '';
			for await (color of handleColor()) {}
			mappings[color] = selfId;
			const otherColor = color === 'black' ? 'white' : 'black';
			mappings[otherColor] = systemId;

			document.getElementById('color-me').textContent = `Color: ${color}`;
			document.getElementById('color-them').textContent = `Color: ${otherColor}`;

			const game = new Chess();
			const [sendMove, getMove] = roomObj.makeAction('move');
			function _sendMove(...iter){ if (soundOn) effect.play(); sendMove(...iter); }

			const promoteRank = { b:1, w:8 };

			async function handlePromote(from,to){
				const parent = document.querySelector('#board2');
				const promoTemplate = document.getElementById('promo-template').firstElementChild.cloneNode(true);
				const card = promoTemplate.querySelector('#promo-card');
				const pieces = ['r','n','b','q'];
				card.innerHTML = '';
				for (const p of pieces){
					const btn = document.createElement('button');
					btn.innerHTML = `<img src="/webrtc-chess/img/chesspieces/wikipedia/${color[0]}${p.toUpperCase()}.png" alt="${p}">`;
					btn.addEventListener('click', ()=>{
						parent.removeChild(promoTemplate);
						const myMove = { from, to, promotion: p };
						game.move(myMove);
						board.position(game.fen());
						_sendMove(myMove, systemId);
					});
					card.appendChild(btn);
				}
				parent.appendChild(promoTemplate);
				return new Promise(()=>{}); // resolved by user action above
			}

			const board = Chessboard('board2', {
				draggable:true,
				position:'start',
				orientation: color,
				pieceTheme: piece => `/webrtc-chess/img/chesspieces/wikipedia/${piece}.png`,
				onDragStart(source, piece){
					if (game.game_over()) return false;
					if (piece[0] !== color[0]) return false;
					if (game.turn() !== color[0]) return false;
				},
				async onDrop(source, target, piece){
					const canPromote = piece[1].toUpperCase() === 'P' && promoteRank[piece[0]] == target[1];
					if (canPromote) {
						if (!game.moves({verbose:true}).some(m => m.from == source && m.to == target)) return 'snapback';
						await handlePromote(source, target);
						return 'trash';
					}
					try{
						const myMove = { from: source, to: target };
						const isOk = game.move(myMove);
						if (isOk){ _sendMove(myMove, systemId); updateUI(); return true; }
						return 'snapback';
					}catch(e){ return 'snapback'; }
				},
				onSnapEnd(){ board.position(game.fen()); }
			});

			function updateUI(){
				document.getElementById('fen').textContent = game.fen();
				document.getElementById('moves').textContent = game.history().length;
				document.getElementById('last-move').textContent = game.history({verbose:true}).slice(-1)[0]?.san || 'â€”';
				document.getElementById('turnVal').textContent = game.turn() === 'w' ? 'White' : 'Black';
				const st = document.getElementById('game-status');
				if (game.in_checkmate()) { st.textContent = 'Checkmate'; st.style.color = 'var(--danger)'; }
				else if (game.in_check()) { st.textContent = 'Check'; st.style.color = ''; }
				else if (game.in_draw() || game.in_stalemate()) { st.textContent = 'Draw / Stalemate'; st.style.color = ''; }
				else { st.textContent = 'Playing'; st.style.color = ''; }
			}
			updateUI();

			getMove((move, friendId)=>{
				if (friendId !== systemId) return;
				game.move(move);
				board.position(game.fen());
				if (soundOn) effect.play();
				updateUI();
			});

			document.getElementById('btn-new').addEventListener('click', ()=>{ game.reset(); board.start(); updateUI(); });
			document.getElementById('btn-resign').addEventListener('click', ()=>{ if(confirm('Resign?')){ game.reset(); board.start(); updateUI(); roomObj.leave(); }});
			document.getElementById('btn-offer').addEventListener('click', ()=>{ alert('Draw offered (UI only)'); });

			const loading = document.getElementById('board-loading'); if (loading) loading.style.display = 'none';
		};
	</script>
</body>
</html>

