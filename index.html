<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>WebRTC Chess</title>
	<script src="/webrtc-chess/chess.min.js"></script>
	<link rel="icon" type="image/x-icon" href="/webrtc-chess/favicon.ico" />
	<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous" />
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>

	<style>
		:root{
			--bg:#0f1720;
			--card:#0b1220;
			--muted:#94a3b8;
			--accent:#06b6d4;
			--glass: rgba(255,255,255,0.04);
			--glass-2: rgba(255,255,255,0.02);
			--success:#10b981;
			--danger:#ef4444;
			--radius:12px;
			--gap:16px;
		}
		*{box-sizing:border-box}
		html,body{height:100%}
		body{
			margin:0;
			font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
			background:
				radial-gradient(1200px 600px at -10% 20%, rgba(6,182,212,0.06), transparent 8%),
				radial-gradient(900px 500px at 120% 80%, rgba(16,185,129,0.03), transparent 6%),
				var(--bg);
			color:#e6eef6;
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			padding:24px;
		}

		.container{
			max-width:1200px;
			margin:0 auto;
			display:grid;
			grid-template-columns: 420px 1fr;
			gap:var(--gap);
			align-items:start;
		}

		.header{
			grid-column:1/3;
			display:flex;
			justify-content:space-between;
			align-items:center;
			margin-bottom:6px;
		}
		.title{
			font-weight:600;
			letter-spacing:0.2px;
			font-size:20px;
		}
		.sub{
			color:var(--muted);
			font-size:13px;
			margin-top:4px;
		}

		.panel{
			background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
			border-radius:var(--radius);
			padding:16px;
			box-shadow: 0 6px 20px rgba(2,6,23,0.6);
			border: 1px solid rgba(255,255,255,0.03);
		}

		.left{
			display:flex;
			flex-direction:column;
			gap:var(--gap);
		}

		.board-card{
			display:flex;
			flex-direction:column;
			align-items:center;
			justify-content:center;
			padding:18px;
			min-height:520px;
		}

		#board2{
			width:100%;
			max-width:520px;
			aspect-ratio:1/1;
			background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.06));
			border-radius:10px;
			padding:8px;
			box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
			position:relative;
		}
		.board-wrap{
			width:100%;
			height:100%;
			display:flex;
			align-items:center;
			justify-content:center;
		}

		.info{
			display:flex;
			flex-direction:column;
			gap:10px;
		}
		.player{
			display:flex;
			align-items:center;
			justify-content:space-between;
			padding:10px;
			background:var(--glass);
			border-radius:10px;
		}
		.player .meta{display:flex;gap:10px;align-items:center}
		.avatar{
			width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021022;
		}
		.name{font-weight:600}
		.small{font-size:13px;color:var(--muted)}

		.controls{
			display:flex;
			gap:10px;
			flex-wrap:wrap;
		}
		button.btn{
			background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
			border:1px solid rgba(255,255,255,0.04);
			color:inherit;
			padding:10px 12px;
			border-radius:10px;
			cursor:pointer;
			font-weight:600;
			min-width:110px;
		}
		button.primary{
			background:linear-gradient(90deg,var(--accent),#7c3aed);
			color:#021022;
			border:none;
		}
		button.ghost{
			background:transparent;border:1px dashed rgba(255,255,255,0.04)
		}

		.status{
			margin-top:8px;
			padding:10px;
			border-radius:8px;
			background:var(--glass-2);
			color:var(--muted);
			font-size:14px;
		}

		.right{
			display:flex;
			flex-direction:column;
			gap:var(--gap);
		}

		.panel .section-title{
			font-size:13px;color:var(--muted);margin-bottom:8px;font-weight:600
		}

		.controls .small{
			font-size:12px;color:var(--muted)
		}

		.promo-overlay{
			position:absolute;
			inset:0;
			display:flex;
			align-items:center;
			justify-content:center;
			backdrop-filter: blur(6px) saturate(1.2);
			background:linear-gradient(180deg, rgba(2,6,23,0.35), rgba(2,6,23,0.6));
			border-radius:10px;
			z-index:30;
		}
		.promo-card{
			background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
			padding:12px;border-radius:10px;display:flex;gap:8px;
		}
		.promo-card button{padding:8px;border-radius:6px;background:transparent;border:none;cursor:pointer}
		.promo-card img{width:44px;height:44px;display:block}

		.footer{
			grid-column:1/3;
			margin-top:4px;
			color:var(--muted);
			font-size:13px;
			display:flex;
			justify-content:space-between;
			align-items:center;
		}

		/* responsive */
		@media (max-width:1000px){
			.container{grid-template-columns:1fr; padding-bottom:30px}
			.header{flex-direction:column; align-items:flex-start; gap:6px}
			#board2{max-width:92vw}
		}
	</style>
</head>
<body>
	<div class="container">
		<header class="header">
			<div>
				<div class="title">WebRTC Chess</div>
				<div class="sub">Private peer-to-peer game â€” responsive UI</div>
			</div>
			<div style="display:flex;gap:10px;align-items:center;">
				<div class="small" id="room-id">Room: <strong id="roomVal">â€”</strong></div>
				<button class="btn ghost" id="soundToggle">ðŸ”Š</button>
			</div>
		</header>

		<!-- left: board -->
		<section class="left panel board-card" aria-label="Chess board panel">
			<div id="board2" class="board-wrap">
				<!-- chessboardjs will mount here -->
				<div id="board-loading" style="text-align:center;color:var(--muted)">
					<p>Finding others...</p>
				</div>
			</div>
			<div class="controls" style="margin-top:12px; width:100%;">
				<button class="btn primary" id="btn-new">New Game</button>
				<button class="btn" id="btn-resign">Resign</button>
				<button class="btn" id="btn-offer">Offer Draw</button>
				<div style="flex:1"></div>
				<div class="small" id="turn-indicator">Turn: <strong id="turnVal">â€”</strong></div>
			</div>
			<div class="status" id="game-status">Status: waiting for playerâ€¦</div>
		</section>

		<!-- right: players & chat / actions -->
		<aside class="right">
			<div class="panel">
				<div class="section-title">Players</div>
				<div class="info">
					<div class="player" id="player-me">
						<div class="meta">
							<div class="avatar" id="avatar-me">Me</div>
							<div>
								<div class="name" id="name-me">You</div>
								<div class="small" id="color-me">Color: â€”</div>
							</div>
						</div>
						<div class="small" id="score-me">â€“</div>
					</div>

					<div class="player" id="player-them">
						<div class="meta">
							<div class="avatar" id="avatar-them">OP</div>
							<div>
								<div class="name" id="name-them">Opponent</div>
								<div class="small" id="color-them">Color: â€”</div>
							</div>
						</div>
						<div class="small" id="score-them">â€“</div>
					</div>
				</div>
			</div>

			<div class="panel">
				<div class="section-title">Game Info</div>
				<div style="display:flex;flex-direction:column;gap:8px">
					<div class="small">FEN: <span id="fen">â€”</span></div>
					<div class="small">Moves: <span id="moves">0</span></div>
					<div class="small">Last move: <span id="last-move">â€”</span></div>
				</div>
			</div>
		</aside>

		<div class="footer">
			<div>Built with WebRTC & Chess.js</div>
			<div class="small">Tips: drag pieces to move â€¢ click controls to act</div>
		</div>
	</div>

	<!-- Promotion overlay template (hidden until needed) -->
	<div id="promo-template" style="display:none">
		<div class="promo-overlay" role="dialog" aria-modal="true">
			<div class="promo-card" id="promo-card">
				<!-- buttons inserted dynamically -->
			</div>
		</div>
	</div>

	<script type="module">
		import {joinRoom, selfId} from '/webrtc-chess/trystero-mqtt.min.js';

		// keep your helpers and decrypt logic verbatim (trimmed for brevity here â€” same as original)
		async function base64ToArrayBuffer(b64){const bin=atob(b64);const len=bin.length;const buf=new Uint8Array(len);for(let i=0;i<len;i++)buf[i]=bin.charCodeAt(i);return buf.buffer}
		async function decrypt(key,payload){const KEY_LEN=32;const ALGO='AES-GCM';const keyBuf=await base64ToArrayBuffer(key);if(keyBuf.byteLength!==KEY_LEN)throw new Error('masterKey must be 32 bytes (base64-encoded)');const ivBuf=new Uint8Array(await base64ToArrayBuffer(payload.iv));const ctBuf=new Uint8Array(await base64ToArrayBuffer(payload.ciphertext));const tagBuf=new Uint8Array(await base64ToArrayBuffer(payload.tag));const combined=new Uint8Array(ctBuf.length+tagBuf.length);combined.set(ctBuf,0);combined.set(tagBuf,ctBuf.length);const cryptoKey=await crypto.subtle.importKey('raw',keyBuf,{name:ALGO},false,['decrypt']);const plainBuf=await crypto.subtle.decrypt({name:ALGO,iv:ivBuf,tagLength:128},cryptoKey,combined.buffer);const x = new TextDecoder().decode(plainBuf); console.log(x); return x;}

		window.onload = async () => {
			const effect = new Audio('/webrtc-chess/img/effect.mp3');
			let soundOn = true;
			const soundToggle = document.getElementById('soundToggle');
			soundToggle.addEventListener('click', ()=>{ soundOn = !soundOn; soundToggle.textContent = soundOn ? 'ðŸ”Š' : 'ðŸ”ˆ'; });

			const roomObj = joinRoom({
				appId: 'michael-chess-app-dcb25a3c-7064-40f8-aef7-593ca98b3e3c',
				rtcConfig: {
					iceServers: [
						{
							urls: ['turn:1xoxshf.257.cz:3478'],
							...JSON.parse(await decrypt('dfGHBn6y+efs/KewqK35WwBJ1AT4jzFOrkNHTb8El3s=', {
								iv: 'S1uthG23SvdgvThn',
								ciphertext: 'F7B9jtXqLBZKAmp1ptHzTizsQA3AlwvOH7j7vgYiLmc3BR7l8g225WtShR7v07hbYaxpPdNfQKKKp7dsvb4=',
								tag: '5qsE+oIAHUtCaBQgBQzWHQ=='
							}))
						},
						{ urls:['stun:stun.nextcloud.com:3478'] }
					]
				}
			}, 'f50782ab-81f7-4f84-84c3-02a40dd52df6');

			document.getElementById('roomVal').textContent = roomObj.id || 'â€”';

			// keep the same matchmaking color routine
			let systemId = '';
			async function* handleColor() {
				const options = ['r','p','s'];
				const [sendColor, getColor] = roomObj.makeAction('handleColor');
				let _resp = null;
				while (!_resp) {
					const userIndex = Math.floor(Math.random()*options.length);
					const option = options[userIndex];
					sendColor(option);
					roomObj.onPeerJoin(peerId => sendColor(option, peerId));
					_resp = await new Promise(resp => {
						getColor((color, friendId) => {
							systemId = friendId;
							const systemIndex = options.indexOf(color);
							const score = systemIndex - userIndex;
							if (score == 1 || score == -2) return resp('black');
							if (score == 0) resp(null);
							resp('white');
						});
					});
					yield _resp;
				}
			}
			roomObj.onPeerLeave(peerId => {
				if (peerId !== systemId) return;
				alert('Other user left! Leaving...');
				roomObj.leave();
				window.location.reload();
			});
			const mappings = {};
			let color = '';
			for await (color of handleColor()) {}
			mappings[color] = selfId;
			const otherColor = color === 'black' ? 'white' : 'black';
			mappings[otherColor] = systemId;

			// UI references
			const nameMe = document.getElementById('name-me');
			const nameThem = document.getElementById('name-them');
			const colorMe = document.getElementById('color-me');
			const colorThem = document.getElementById('color-them');
			const turnVal = document.getElementById('turnVal');
			const gameStatus = document.getElementById('game-status');
			const fenEl = document.getElementById('fen');
			const movesEl = document.getElementById('moves');
			const lastMoveEl = document.getElementById('last-move');

			colorMe.textContent = `Color: ${color}`;
			colorThem.textContent = `Color: ${otherColor}`;

			const game = new Chess();
			const [sendMove, getMove] = roomObj.makeAction('move');
			function _sendMove(...iter){
				if (soundOn) effect.play();
				sendMove(...iter);
			}

			const promoteRank = { b:1, w:8 };

			// promotion UI helper
			async function handlePromote(from, to){
				const parent = document.querySelector('#board2');
				const promoTemplate = document.getElementById('promo-template').firstElementChild.cloneNode(true);
				const card = promoTemplate.querySelector('#promo-card');
				const pieces = ['r','n','b','q'];
				card.innerHTML = '';
				for (const p of pieces){
					const btn = document.createElement('button');
					btn.innerHTML = `<img src="/webrtc-chess/img/chesspieces/wikipedia/${color[0]}${p.toUpperCase()}.png" alt="${p}">`;
					btn.addEventListener('click', ()=>{
						parent.removeChild(promoTemplate);
						const myMove = { from, to, promotion: p };
						game.move(myMove);
						board.position(game.fen());
						_sendMove(myMove, systemId);
					});
					card.appendChild(btn);
				}
				parent.appendChild(promoTemplate);
				return new Promise(resolve => {});
			}

			// mount chessboard
			const board = Chessboard('board2', {
				draggable:true,
				position:'start',
				orientation: color,
				pieceTheme: piece => `/webrtc-chess/img/chesspieces/wikipedia/${piece}.png`,
				onDragStart(source, piece, position, orientation){
					if (game.game_over()) return false;
					if (piece[0] !== color[0]) return false;
					if (game.turn() !== color[0]) return false;
				},
				async onDrop(source, target, piece){
					const canPromote = piece[1].toUpperCase() === 'P' && promoteRank[piece[0]] == target[1];
					if (canPromote) {
						// validate move exists
						if (!game.moves({verbose:true}).some(m => m.from == source && m.to == target)) return 'snapback';
						await handlePromote(source, target);
						return 'trash';
					}
					try {
						const myMove = { from: source, to: target };
						const isOk = game.move(myMove);
						if (isOk){
							_sendMove(myMove, systemId);
							updateUI();
							return true;
						}
						return 'snapback';
					} catch (e){
						return 'snapback';
					}
				},
				onSnapEnd(){ board.position(game.fen()); }
			});

			function updateUI(){
				fenEl.textContent = game.fen();
				movesEl.textContent = game.history().length;
				lastMoveEl.textContent = game.history({verbose:true}).slice(-1)[0]?.san || 'â€”';
				turnVal.textContent = game.turn() === 'w' ? 'White' : 'Black';
				if (game.in_checkmate()) { gameStatus.textContent = 'Checkmate'; gameStatus.style.color = 'var(--danger)'; }
				else if (game.in_check()) { gameStatus.textContent = 'Check'; gameStatus.style.color = 'var(--accent)'; }
				else if (game.in_draw() || game.in_stalemate()) { gameStatus.textContent = 'Draw / Stalemate'; gameStatus.style.color = 'var(--muted)'; }
				else { gameStatus.textContent = 'Playing'; gameStatus.style.color = ''; }
			}
			updateUI();

			getMove((move, friendId) => {
				if (friendId !== systemId) return;
				game.move(move);
				board.position(game.fen());
				if (soundOn) effect.play();
				updateUI();
			});

			// controls
			document.getElementById('btn-new').addEventListener('click', ()=>{
				game.reset();
				board.start();
				updateUI();
				// broadcast a reset move if desired
			});
			document.getElementById('btn-resign').addEventListener('click', ()=>{
				if (confirm('Resign the game?')) { game.reset(); board.start(); updateUI(); roomObj.leave(); }
			});
			document.getElementById('btn-offer').addEventListener('click', ()=>{ alert('Draw offered (UI only).'); });

			// remove loading text if board renders
			const loading = document.getElementById('board-loading');
			if (loading) loading.style.display = 'none';
		};
	</script>
</body>
</html>

